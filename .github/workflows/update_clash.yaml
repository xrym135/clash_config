name: Update Clash Config

on:
  schedule:
    - cron: '0 22 * * *'  # æ¯å¤©æ—©ä¸Š 6 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v3

      - name: ç¡®ä¿ uploads ç›®å½•å­˜åœ¨
        run: mkdir -p uploads

      - name: è·å–æœ€æ–° Clash & V2Ray é…ç½®
        run: |
          TODAY=$(date +"%Y%m%d")
          CLASH_LATEST_URL="https://free.datiya.com/uploads/${TODAY}-clash.yaml"
          V2RAY_LATEST_URL="https://free.datiya.com/uploads/${TODAY}-v2ray.txt"
          CLASH_SAVE_PATH="uploads/clash.yaml"
          V2RAY_SAVE_PATH="uploads/v2ray.txt"

          echo "ğŸ” æ­£åœ¨ä¸‹è½½ Clash é…ç½®: $CLASH_LATEST_URL"
          if curl -o "$CLASH_SAVE_PATH" -L --fail "$CLASH_LATEST_URL"; then
            echo "âœ… Clash é…ç½®ä¸‹è½½æˆåŠŸ: $CLASH_SAVE_PATH"
          else
            echo "âŒ Clash é…ç½®ä¸‹è½½å¤±è´¥ï¼Œè·³è¿‡æ›´æ–°"
            exit 0
          fi

          echo "ğŸ” æ­£åœ¨ä¸‹è½½ V2Ray é…ç½®: $V2RAY_LATEST_URL"
          if curl -o "$V2RAY_SAVE_PATH" -L --fail "$V2RAY_LATEST_URL"; then
            echo "âœ… V2Ray é…ç½®ä¸‹è½½æˆåŠŸ: $V2RAY_SAVE_PATH"
          else
            echo "âŒ V2Ray é…ç½®ä¸‹è½½å¤±è´¥ï¼Œè·³è¿‡æ­¤æ–‡ä»¶æ›´æ–°"
          fi

      - name: è‡ªåŠ¨ä¿®æ”¹ Clash é…ç½®ï¼ˆå¢åŠ  DNS + ä¿®æ”¹ intervalï¼‰
        run: |
          # ä¿®æ”¹ interval: 300 -> 30
          sed -i 's/interval: 300/interval: 30/' uploads/clash.yaml

          echo "âœ… é…ç½®å·²ä¿®æ”¹ï¼šinterval è®¾ä¸º 30"

      - name: æäº¤æ›´æ–°ï¼ˆä»…å½“æ–‡ä»¶æœ‰å˜æ›´ï¼‰
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          if git diff --quiet uploads/clash.yaml; then
            echo "âš ï¸ é…ç½®æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi

          git add uploads/clash.yaml uploads/v2ray.txt
          git commit -m "æ›´æ–°é…ç½®æ–‡ä»¶: $(date +'%Y-%m-%d')"
          git push
